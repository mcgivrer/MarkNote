#!/bin/bash
#---- project parameters
project_name=MarkNote
project_version=0.0.1
main_class=Main
JARS=
JFX_VERSION=25
vendor_name="SNAPGAMES"
author_name="Frédéric Delorme<frederic.delorme@gmail.com>"
#
#--- DO NOT CHANGE THE FOLLOWING LINES ---
#
SRC=./src
LIBS=./libs
TARGET=./target
BUILD=${TARGET}/build
CLASSES=${TARGET}/classes
RESOURCES=${SRC}/main/resources
SOURCE_ENCODING="UTF-8"
SOURCE_VERSION="25"
JARS=libs/
JFX_PATH="libs"
JFX_MODULES="javafx.base,javafx.graphics,javafx.controls,javafx.fxml,javafx.media,javafx.web"
COMPILATION_OPTS="-Xlint:unchecked -Xlint:deprecation -parameters"
JAR_OPTS="-Xmx512m"
RUN_OPT="--module-path ${JFX_PATH} --add-modules ${JFX_MODULES}"
# add your test execution commands here
TEST_CLASSES=${TARGET}/test-classes
TEST_RESOURCES=${SRC}/test/resources
LIB_TEST=$LIBS/junit-platform-console-standalone-6.0.1.jar
# detect OS type to set the classpath separator and JavaFX platform suffix
if [[ "$OSTYPE" == "linux"* ]]; then
    FS=":"
    JFX_OS_SUFFIX="linux"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    FS=":"
    JFX_OS_SUFFIX="mac"
else
    FS=";"
    JFX_OS_SUFFIX="win"
fi
# define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'
#---- process buid
GIT_COMMIT_ID=$(git rev-parse HEAD)
JAVA_BUILD=$(java --version | head -1 | cut -f2 -d' ')
# Prepare Build
rm -vrf target/
find $SRC/main/java $RESOURCES -name "*.java"
mkdir -vp ${TARGET}/{classes,build/libs,jfx-libs}

# Prepare platform-specific JavaFX libs for compilation
echo "Preparing JavaFX libs for ${JFX_OS_SUFFIX}..."
# Copy common libs (platform-independent JavaFX jars + flexmark)
cp ${LIBS}/common/*.jar ${TARGET}/jfx-libs/
# Copy platform-specific JavaFX jars (native bindings)
cp ${LIBS}/${JFX_OS_SUFFIX}/*.jar ${TARGET}/jfx-libs/ 2>/dev/null || true

# Compile sources using platform-specific libs
JFX_COMPILE_PATH="${TARGET}/jfx-libs"
javac ${COMPILATION_OPTS} --module-path ${JFX_COMPILE_PATH} --add-modules ${JFX_MODULES} -cp "${JFX_COMPILE_PATH}/*" $(find $SRC/main/java $RESOURCES -name "*.java") -d ${CLASSES}
# create MANIFEST file
cp -vr $RESOURCES/* $CLASSES
echo "done."
echo ---
echo "build jar..."
for app in ${main_class}
do
    mkdir -p $TARGET/META-INF
    echo ">> for ${project_name}.$app..."
    echo """
Manifest-Version: ${project_name}
Main-Class: ${app}
Class-Path: ${JARS}
Created-By: ${JAVA_BUILD}
Implementation-Title: ${project_name}
Implementation-Version: ${project_version}-build_${GIT_COMMIT_ID:0:12}
Implementation-Vendor: ${vendor_name}
Implementation-Author: ${author_name}
    """ >>target/META-INF/MANIFEST.MF
    #  jar cvfe target/build/${project_name}-$app-${project_version}.jar $app -C target/classes .
    # Copy libs into build (use pre-prepared platform-specific libs)
    mkdir -p ${BUILD}/libs
    cp -v ${TARGET}/jfx-libs/*.jar ${BUILD}/libs/
    
    jar cvfe target/build/${project_name}-${project_version}.jar $app -C target/classes .
    echo "done."
    # create run script
    echo "create run script ${BUILD}/${project_name}.sh ..."
    rm -f ${BUILD}/${project_name}.sh
    cat > ${BUILD}/${project_name}.sh << 'LAUNCH_EOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# Convert MSYS/Cygwin paths to Windows paths if needed
if command -v cygpath &> /dev/null; then
    SCRIPT_DIR="$(cygpath -w "$SCRIPT_DIR")"
fi
if [[ "$OSTYPE" == "linux"* ]] || [[ "$OSTYPE" == "darwin"* ]]; then
    FS=":"
else
    FS=";"
fi
LAUNCH_EOF
    echo "java --module-path \"\${SCRIPT_DIR}/libs\" --add-modules ${JFX_MODULES} -cp \"\${SCRIPT_DIR}/${project_name}-${project_version}.jar\${FS}\${SCRIPT_DIR}/libs/*\" $app \"\$@\"" >> ${BUILD}/${project_name}.sh
    chmod +x ${BUILD}/${project_name}.sh
done
echo "done."
# Run tests
if( [ "$1" == "test" ] ); then
    echo "Run tests..."
    
    echo -e "|_ ${BLUE}6. Execute tests${NC}..."
    echo "> from : ${SRC}/test"
    echo "> to   : ${TARGET}/test-classes"
    mkdir -p ${TARGET}/test-classes
    echo "copy test resources"
    cp -r ./$RESOURCES/* $TEST_CLASSES
    cp -r ./$TEST_RESOURCES/* $TEST_CLASSES
    echo "compile test classes"
    #list test sources
    find ${SRC}/main -name '*.java' >${TARGET}/sources.lst
    find ${SRC}/test -name '*.java' >${TARGET}/test-sources.lst
    javac -source $SOURCE_VERSION -encoding $SOURCE_ENCODING $COMPILATION_OPTS -cp ".${FS}$LIB_TEST${FS}${EXTERNAL_JARS}" -d $TEST_CLASSES @${TARGET}/sources.lst @${TARGET}/test-sources.lst
    echo "execute tests through JUnit"
    java $JAR_OPTS -jar $LIB_TEST execute -cp "${EXTERNAL_JARS}${FS}${CLASSES}${FS}${TEST_CLASSES}${FS}." --scan-class-path
    echo -e "   |_ ${GREEN}done$NC"
    echo "- execute tests through JUnit ${SRC}/test." >>${TARGET}/build.log
fi

if( [ "$1" == "run" ] ); then
    echo "Run the generated JAR(s)..."
    for app in ${main_class}
    do
        #    echo ">> run JAR ${project_name}-$app-${project_version}.jar ..."
        echo ">> run JAR ${project_name}-${project_version}.jar ..."
        shift 1
        #    java $RUN_OPT -jar ${TARGET}/build/${project_name}-$app-${project_version}.jar $@
        java --module-path "${TARGET}/build/libs" --add-modules ${JFX_MODULES} -cp "${TARGET}/build/${project_name}-${project_version}.jar${FS}${TARGET}/build/libs/*" $app $@
        echo "done."
    done
fi

if( [ "$1" == "package" ] ); then
    echo "Creating distribution package..."
    
    DIST_DIR="${TARGET}/dist/${project_name}-${project_version}-${JFX_OS_SUFFIX}"
    JRE_DIR="${DIST_DIR}/jre"
    
    # Clean and create distribution directory
    rm -rf "${TARGET}/dist"
    mkdir -p "${DIST_DIR}"
    
    # Copy build artifacts
    echo "Copying build artifacts..."
    cp "${BUILD}/${project_name}-${project_version}.jar" "${DIST_DIR}/"
    mkdir -p "${DIST_DIR}/libs"
    cp ${BUILD}/libs/*.jar "${DIST_DIR}/libs/"
    
    # Create minimal JRE with jlink
    echo "Creating minimal JRE with jlink..."
    # Modules required for JavaFX application
    JRE_MODULES="java.base,java.desktop,java.logging,java.xml,java.net.http,java.scripting,jdk.xml.dom,java.sql,java.naming,java.prefs,jdk.unsupported,jdk.jsobject"
    
    # Add JavaFX modules path for jlink
    jlink --module-path "${TARGET}/jfx-libs" \
          --add-modules ${JRE_MODULES} \
          --output "${JRE_DIR}" \
          --strip-debug \
          --compress zip-6 \
          --no-header-files \
          --no-man-pages
    
    echo "JRE created: $(du -sh ${JRE_DIR} | cut -f1)"
    
    # Create launcher script using embedded JRE
    echo "Creating launcher script..."
    if [[ "$JFX_OS_SUFFIX" == "win" ]]; then
        # Windows batch script
        cat > "${DIST_DIR}/${project_name}.bat" << WINLAUNCHER
@echo off
setlocal
set SCRIPT_DIR=%~dp0
set JRE_PATH=%SCRIPT_DIR%jre\\bin\\java.exe
"%JRE_PATH%" --module-path "%SCRIPT_DIR%libs" --add-modules ${JFX_MODULES} -cp "%SCRIPT_DIR%${project_name}-${project_version}.jar;%SCRIPT_DIR%libs\\*" ${main_class} %*
endlocal
WINLAUNCHER
    else
        # Unix shell script
        cat > "${DIST_DIR}/${project_name}.sh" << 'UNIXLAUNCHER_START'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
JRE_PATH="${SCRIPT_DIR}/jre/bin/java"
UNIXLAUNCHER_START
        echo "\"\${JRE_PATH}\" --module-path \"\${SCRIPT_DIR}/libs\" --add-modules ${JFX_MODULES} -cp \"\${SCRIPT_DIR}/${project_name}-${project_version}.jar:\${SCRIPT_DIR}/libs/*\" ${main_class} \"\$@\"" >> "${DIST_DIR}/${project_name}.sh"
        chmod +x "${DIST_DIR}/${project_name}.sh"
    fi
    
    # Create ZIP archive
    echo "Creating ZIP archive..."
    PACKAGE_NAME="${project_name}-${project_version}-${JFX_OS_SUFFIX}.zip"
    cd "${TARGET}/dist"
    zip -r "../${PACKAGE_NAME}" "${project_name}-${project_version}-${JFX_OS_SUFFIX}"
    cd - > /dev/null
    
    echo -e "${GREEN}Package created: ${TARGET}/${PACKAGE_NAME}${NC}"
    echo "Package size: $(du -sh ${TARGET}/${PACKAGE_NAME} | cut -f1)"
    echo "done."
fi
