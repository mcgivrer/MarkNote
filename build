#!/bin/bash
#---- project parameters
project_name=MarkNote
project_version=0.0.1
main_class=MarkNote
JARS=
JFX_VERSION=25
vendor_name="SNAPGAMES"
author_name="Frédéric Delorme<frederic.delorme@gmail.com>"
#
#--- DO NOT CHANGE THE FOLLOWING LINES ---
#
SRC=./src
LIBS=./libs
TARGET=./target
BUILD=${TARGET}/build
CLASSES=${TARGET}/classes
RESOURCES=${SRC}/main/resources
SOURCE_ENCODING="UTF-8"
SOURCE_VERSION="25"
JARS=libs/
JFX_PATH="libs"
JFX_MODULES="javafx.base,javafx.graphics,javafx.controls,javafx.fxml,javafx.media,javafx.web"
COMPILATION_OPTS="-Xlint:unchecked -Xlint:deprecation -parameters"
JAR_OPTS="-Xmx512m"
RUN_OPT="--module-path ${JFX_PATH} --add-modules ${JFX_MODULES}"
# add your test execution commands here
TEST_CLASSES=${TARGET}/test-classes
TEST_RESOURCES=${SRC}/test/resources
LIB_TEST=$LIBS/junit-platform-console-standalone-6.0.1.jar
# detect OS type to set the classpath separator and JavaFX platform suffix
if [[ "$OSTYPE" == "linux"* ]]; then
    FS=":"
    JFX_OS_SUFFIX="linux"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    FS=":"
    JFX_OS_SUFFIX="mac"
else
    FS=";"
    JFX_OS_SUFFIX="win"
fi
# define colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'
#---- process buid
GIT_COMMIT_ID=$(git rev-parse HEAD)
JAVA_BUILD=$(java --version | head -1 | cut -f2 -d' ')
# Prepare Build
rm -vrf target/
find $SRC/main/java $RESOURCES -name "*.java"
mkdir -vp ${TARGET}/{classes,build/libs,jfx-libs}

# Prepare platform-specific JavaFX libs for compilation
echo "Preparing JavaFX libs for ${JFX_OS_SUFFIX}..."
# Copy platform-independent JavaFX jars (API)
for jar in ${LIBS}/javafx-*-24.jar; do
    jarname=$(basename "$jar")
    # Skip platform-specific jars
    if [[ ! "$jarname" =~ -linux\.jar$ ]] && [[ ! "$jarname" =~ -win\.jar$ ]] && [[ ! "$jarname" =~ -mac\.jar$ ]]; then
        cp "$jar" ${TARGET}/jfx-libs/
    fi
done
# Copy platform-specific JavaFX jars (native bindings)
cp ${LIBS}/javafx-*-24-${JFX_OS_SUFFIX}.jar ${TARGET}/jfx-libs/ 2>/dev/null || true
# Copy non-JavaFX libs
for jar in ${LIBS}/*.jar; do
    jarname=$(basename "$jar")
    if [[ ! "$jarname" =~ ^javafx- ]]; then
        cp "$jar" ${TARGET}/jfx-libs/
    fi
done

# Compile sources using platform-specific libs
JFX_COMPILE_PATH="${TARGET}/jfx-libs"
javac ${COMPILATION_OPTS} --module-path ${JFX_COMPILE_PATH} --add-modules ${JFX_MODULES} -cp "${JFX_COMPILE_PATH}/*" $(find $SRC/main/java $RESOURCES -name "*.java") -d ${CLASSES}
# create MANIFEST file
cp -vr $RESOURCES/* $CLASSES
echo "done."
echo ---
echo "build jar..."
for app in ${main_class}
do
    mkdir -p $TARGET/META-INF
    echo ">> for ${project_name}.$app..."
    echo """
Manifest-Version: ${project_name}
Main-Class: ${app}
Class-Path: ${JARS}
Created-By: ${JAVA_BUILD}
Implementation-Title: ${project_name}
Implementation-Version: ${project_version}-build_${GIT_COMMIT_ID:0:12}
Implementation-Vendor: ${vendor_name}
Implementation-Author: ${author_name}
    """ >>target/META-INF/MANIFEST.MF
    #  jar cvfe target/build/${project_name}-$app-${project_version}.jar $app -C target/classes .
    # Copy libs into build (use pre-prepared platform-specific libs)
    mkdir -p ${BUILD}/libs
    cp -v ${TARGET}/jfx-libs/*.jar ${BUILD}/libs/
    
    jar cvfe target/build/${project_name}-${project_version}.jar $app -C target/classes .
    echo "done."
    # create run script
    echo "create run script ${BUILD}/${project_name}.sh ..."
    rm -f ${BUILD}/${project_name}.sh
    cat > ${BUILD}/${project_name}.sh << 'LAUNCH_EOF'
#!/bin/bash
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
# Convert MSYS/Cygwin paths to Windows paths if needed
if command -v cygpath &> /dev/null; then
    SCRIPT_DIR="$(cygpath -w "$SCRIPT_DIR")"
fi
if [[ "$OSTYPE" == "linux"* ]] || [[ "$OSTYPE" == "darwin"* ]]; then
    FS=":"
else
    FS=";"
fi
LAUNCH_EOF
    echo "java --module-path \"\${SCRIPT_DIR}/libs\" --add-modules ${JFX_MODULES} -cp \"\${SCRIPT_DIR}/${project_name}-${project_version}.jar\${FS}\${SCRIPT_DIR}/libs/*\" $app \"\$@\"" >> ${BUILD}/${project_name}.sh
    chmod +x ${BUILD}/${project_name}.sh
done
echo "done."
# Run tests
if( [ "$1" == "test" ] ); then
    echo "Run tests..."
    
    echo -e "|_ ${BLUE}6. Execute tests${NC}..."
    echo "> from : ${SRC}/test"
    echo "> to   : ${TARGET}/test-classes"
    mkdir -p ${TARGET}/test-classes
    echo "copy test resources"
    cp -r ./$RESOURCES/* $TEST_CLASSES
    cp -r ./$TEST_RESOURCES/* $TEST_CLASSES
    echo "compile test classes"
    #list test sources
    find ${SRC}/main -name '*.java' >${TARGET}/sources.lst
    find ${SRC}/test -name '*.java' >${TARGET}/test-sources.lst
    javac -source $SOURCE_VERSION -encoding $SOURCE_ENCODING $COMPILATION_OPTS -cp ".${FS}$LIB_TEST${FS}${EXTERNAL_JARS}" -d $TEST_CLASSES @${TARGET}/sources.lst @${TARGET}/test-sources.lst
    echo "execute tests through JUnit"
    java $JAR_OPTS -jar $LIB_TEST execute -cp "${EXTERNAL_JARS}${FS}${CLASSES}${FS}${TEST_CLASSES}${FS}." --scan-class-path
    echo -e "   |_ ${GREEN}done$NC"
    echo "- execute tests through JUnit ${SRC}/test." >>${TARGET}/build.log
fi

if( [ "$1" == "run" ] ); then
    echo "Run the generated JAR(s)..."
    for app in ${main_class}
    do
        #    echo ">> run JAR ${project_name}-$app-${project_version}.jar ..."
        echo ">> run JAR ${project_name}-${project_version}.jar ..."
        shift 1
        #    java $RUN_OPT -jar ${TARGET}/build/${project_name}-$app-${project_version}.jar $@
        java --module-path "${TARGET}/build/libs" --add-modules ${JFX_MODULES} -cp "${TARGET}/build/${project_name}-${project_version}.jar${FS}${TARGET}/build/libs/*" $app $@
        echo "done."
    done
fi
